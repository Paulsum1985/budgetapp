<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Personal Budget</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;600;700&display=swap" rel="stylesheet">

    <style>
        /* --- CSS RESET & DEFAULTS --- */
        :root {
            --bg-color: #0d0d12;
            --surface-color: #1a1a24;
            --surface-hover: #262636;
            --primary-text: #F2F2F7;
            --secondary-text: #8E8E93;
            
            /* Enhanced Neon Palette */
            --accent-teal: #00F0FF;
            --accent-pink: #FF2E93;
            --accent-blue: #4D79FF;
            --accent-purple: #BD00FF;
            --accent-yellow: #FFD60A;
            --accent-orange: #FF9F0A;
            --accent-green: #30D158;
            
            --border-color: rgba(255, 255, 255, 0.08);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --border-radius: 16px;
            --font-display: 'Outfit', sans-serif;
            --font-body: 'Inter', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--bg-color);
            color: var(--primary-text);
            font-size: 15px;
            overflow-x: hidden;
            overscroll-behavior-y: none;
        }

        /* --- BACKGROUND ANIMATION --- */
        #particle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
            opacity: 0.6;
        }

        .gradient-orb {
            position: fixed;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            opacity: 0.25;
            animation: orbFloat 10s infinite ease-in-out alternate;
        }
        .orb-1 { top: -10%; left: -10%; width: 60vw; height: 60vw; background: var(--accent-purple); }
        .orb-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: var(--accent-teal); animation-delay: -5s; }

        @keyframes orbFloat {
            0% { transform: translate(0, 0); }
            100% { transform: translate(20px, 40px); }
        }

        /* --- LAYOUT --- */
        .app-container {
            max-width: 480px;
            margin: 0 auto;
            padding: 20px 20px 100px 20px;
            position: relative;
            z-index: 1;
        }

        /* --- HEADER --- */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-top: 10px;
        }

        .month-navigator {
            display: flex;
            align-items: center;
            gap: 12px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(12px);
            padding: 6px 16px;
            border-radius: 30px;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .nav-btn {
            background: none; border: none; cursor: pointer; padding: 4px;
            display: flex; align-items: center; justify-content: center;
        }
        .nav-btn svg {
            width: 20px; height: 20px;
            fill: var(--secondary-text);
            transition: fill 0.3s ease;
        }
        .nav-btn:hover svg { fill: var(--primary-text); }

        #headerDate {
            font-family: var(--font-display);
            font-size: 17px;
            font-weight: 600;
            letter-spacing: 0.5px;
            min-width: 140px;
            text-align: center;
        }

        .settings-btn {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 44px; height: 44px;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.2s ease;
        }
        .settings-btn:active { transform: scale(0.95); background: rgba(255,255,255,0.1); }
        .settings-btn svg { width: 22px; height: 22px; fill: var(--primary-text); }

        /* --- CARDS (GLASSMORPHISM) --- */
        .glass-card {
            background: rgba(26, 26, 36, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.2);
            overflow: hidden;
            transition: transform 0.2s ease;
        }

        /* --- SUMMARY --- */
        .summary-grid {
            display: grid; 
            grid-template-columns: repeat(2, 1fr);
            gap: 16px; 
            margin-bottom: 24px;
        }
        .summary-card {
            padding: 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }
        .summary-card.balance {
            grid-column: 1 / -1;
            padding: 24px;
            background: linear-gradient(135deg, rgba(26,26,36,0.8), rgba(13,13,18,0.9));
            border: 1px solid rgba(255,255,255,0.1);
        }
        
        .summary-label {
            font-size: 13px; font-weight: 500; color: var(--secondary-text);
            margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px;
        }
        
        .summary-value {
            font-family: var(--font-display);
            font-size: 22px; font-weight: 700;
        }
        
        #totalIncome { color: var(--accent-teal); text-shadow: 0 0 15px rgba(0, 240, 255, 0.3); }
        #totalExpenses { color: var(--accent-pink); text-shadow: 0 0 15px rgba(255, 46, 147, 0.3); }
        
        #balance {
            font-size: 36px;
            background: linear-gradient(to right, #fff, #b3b3b3);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* --- BUDGET OVERVIEW --- */
        .section-title {
            font-family: var(--font-display);
            font-size: 18px; font-weight: 600;
            margin-bottom: 16px; margin-left: 4px;
            color: var(--primary-text);
            display: flex; align-items: center; gap: 8px;
        }
        
        .budget-overview { padding: 20px; margin-bottom: 24px; }
        
        .breakdown-item { margin-bottom: 16px; }
        .breakdown-item:last-child { margin-bottom: 0; }
        
        .breakdown-header {
            display: flex; justify-content: space-between;
            font-size: 14px; margin-bottom: 8px;
        }
        .cat-name { font-weight: 500; }
        .cat-amount { font-weight: 600; font-family: var(--font-display); }
        
        .progress-track {
            width: 100%; height: 6px;
            background: rgba(255,255,255,0.05);
            border-radius: 10px; overflow: hidden;
        }
        .progress-fill {
            height: 100%; border-radius: 10px;
            box-shadow: 0 0 10px currentColor;
            transition: width 0.8s cubic-bezier(0.22, 1, 0.36, 1);
        }

        /* --- TRANSACTIONS --- */
        .transaction-list { padding-bottom: 20px; }
        
        .transaction-item {
            position: relative;
            margin-bottom: 12px;
            border-radius: var(--border-radius);
            /* Important for swipe actions */
        }
        
        /* Swipe Actions behind content */
        .swipe-actions {
            position: absolute; top: 0; right: 0; bottom: 0; left: 0;
            display: flex; justify-content: flex-end;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        
        .swipe-btn {
            width: 70px; border: none; color: white;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
            cursor: pointer; gap: 4px; font-size: 10px; font-weight: 600;
        }
        .swipe-btn.edit { background-color: var(--accent-blue); transform: translateX(100%); transition: transform 0.2s; }
        .swipe-btn.delete { background-color: var(--accent-pink); border-top-right-radius: var(--border-radius); border-bottom-right-radius: var(--border-radius); transform: translateX(100%); transition: transform 0.2s 0.05s; }
        .swipe-btn svg { width: 20px; height: 20px; fill: white; }

        /* Actual Content */
        .txn-content {
            position: relative;
            background: var(--surface-color);
            padding: 14px 16px;
            border-radius: var(--border-radius);
            border: 1px solid var(--border-color);
            display: flex; align-items: center;
            z-index: 2;
            transition: transform 0.2s ease-out;
            will-change: transform;
        }
        
        .transaction-item.swiped .txn-content { transform: translateX(-140px); }
        .transaction-item.swiped .swipe-btn { transform: translateX(0); }

        .txn-icon {
            width: 42px; height: 42px;
            border-radius: 12px;
            display: flex; justify-content: center; align-items: center;
            margin-right: 14px;
            background: rgba(255,255,255,0.05);
            flex-shrink: 0;
        }
        .txn-icon svg { width: 22px; height: 22px; }
        
        .txn-info { flex-grow: 1; overflow: hidden; }
        .txn-desc { font-weight: 500; font-size: 15px; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .txn-meta { font-size: 12px; color: var(--secondary-text); }
        
        .txn-amount {
            font-family: var(--font-display);
            font-weight: 600; font-size: 16px;
            margin-left: 12px;
        }
        .txn-amount.income { color: var(--accent-teal); }
        .txn-amount.expense { color: var(--primary-text); }

        .empty-state {
            text-align: center; color: var(--secondary-text);
            padding: 40px 20px;
            background: rgba(255,255,255,0.02);
            border-radius: var(--border-radius);
            border: 1px dashed var(--border-color);
        }
        .empty-state svg { width: 60px; height: 60px; opacity: 0.5; margin-bottom: 16px; stroke: var(--secondary-text); }

        /* --- FAB --- */
        .fab {
            position: fixed; bottom: 30px; left: 50%;
            transform: translateX(-50%);
            width: 64px; height: 64px;
            border-radius: 50%;
            background: var(--accent-teal);
            box-shadow: 0 0 20px rgba(0, 240, 255, 0.4);
            border: none;
            display: flex; justify-content: center; align-items: center;
            cursor: pointer; z-index: 100;
            transition: transform 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .fab:active { transform: translateX(-50%) scale(0.9); }
        .fab svg { width: 30px; height: 30px; fill: #000; }

        /* --- MODALS --- */
        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            z-index: 1000;
            opacity: 0; visibility: hidden;
            transition: opacity 0.3s;
            display: flex; align-items: flex-end; justify-content: center;
        }
        .modal.open { opacity: 1; visibility: visible; }
        
        .modal-card {
            background: #1c1c26;
            width: 100%; max-width: 480px;
            border-radius: 24px 24px 0 0;
            padding: 24px;
            box-shadow: 0 -10px 40px rgba(0,0,0,0.5);
            transform: translateY(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0.8, 0.2, 1);
            max-height: 90vh; overflow-y: auto;
            border-top: 1px solid var(--border-color);
        }
        .modal.open .modal-card { transform: translateY(0); }
        
        .modal-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 24px;
        }
        .modal-title { font-family: var(--font-display); font-size: 20px; font-weight: 600; }
        .close-modal { background: none; border: none; padding: 5px; cursor: pointer; }
        .close-modal svg { width: 24px; height: 24px; fill: var(--secondary-text); }

        /* Form Elements */
        .form-group { margin-bottom: 20px; }
        .label { display: block; font-size: 13px; color: var(--secondary-text); margin-bottom: 8px; font-weight: 500; }
        
        .input-field {
            width: 100%; padding: 14px;
            background: rgba(0,0,0,0.2);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            color: var(--primary-text);
            font-size: 16px; font-family: var(--font-body);
            transition: border-color 0.2s;
        }
        .input-field:focus { outline: none; border-color: var(--accent-teal); }
        
        .toggle-container {
            display: flex; background: rgba(0,0,0,0.3);
            padding: 4px; border-radius: 14px;
        }
        .toggle-option {
            flex: 1; border: none; background: none;
            padding: 10px; color: var(--secondary-text);
            font-weight: 600; border-radius: 10px;
            cursor: pointer; transition: all 0.2s;
        }
        .toggle-option.active.expense { background: var(--surface-hover); color: var(--accent-pink); }
        .toggle-option.active.income { background: var(--surface-hover); color: var(--accent-teal); }
        
        .primary-btn {
            width: 100%; padding: 16px;
            background: var(--primary-text);
            color: black; border: none;
            border-radius: 14px; font-weight: 700; font-size: 16px;
            cursor: pointer; margin-top: 10px;
        }
        .primary-btn:active { opacity: 0.9; transform: scale(0.98); }

        /* Recurring Switch */
        .row-group { display: flex; justify-content: space-between; align-items: center; }
        .switch { position: relative; width: 48px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider {
            position: absolute; inset: 0; cursor: pointer;
            background: #333; border-radius: 30px; transition: .4s;
        }
        .slider:before {
            position: absolute; content: "";
            height: 22px; width: 22px; left: 3px; bottom: 3px;
            background: white; border-radius: 50%; transition: .4s;
        }
        input:checked + .slider { background: var(--accent-teal); }
        input:checked + .slider:before { transform: translateX(20px); }

        /* Custom Select (Category) */
        .category-select-wrapper { display: flex; gap: 10px; }
        #category { flex-grow: 1; appearance: none; background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%238E8E93' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e"); background-repeat: no-repeat; background-position: right 14px center; background-size: 16px; }

        /* Danger Zone */
        .danger-zone { margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); }
        .danger-btn { background: rgba(255, 46, 147, 0.15); color: var(--accent-pink); border: 1px solid rgba(255, 46, 147, 0.3); }

        /* --- UTILS --- */
        .hidden { display: none; }
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    </style>
</head>
<body>
    <div class="gradient-orb orb-1"></div>
    <div class="gradient-orb orb-2"></div>
    <canvas id="particle-canvas"></canvas>

    <div class="app-container">
        <header class="app-header fade-in">
            <div class="month-navigator">
                <button class="nav-btn" id="prevMonthBtn"><svg viewBox="0 0 24 24"><path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg></button>
                <div id="headerDate">January 2024</div>
                <button class="nav-btn" id="nextMonthBtn"><svg viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
            </div>
            <button class="settings-btn" id="openSettingsBtn">
                <svg viewBox="0 0 24 24"><path d="M3 17v2h6v-2H3zM3 5v2h10V5H3zm10 16v-2h8v-2h-8v-2h-2v6h2zM7 9v2H3v2h4v2h2V9H7zm14 4v-2H11v2h10zm-6-4h2V7h4V5h-4V3h-2v6z"></path></svg>
            </button>
        </header>

        <section class="summary-grid fade-in" style="animation-delay: 0.1s;">
            <div class="glass-card summary-card">
                <span class="summary-label">Income</span>
                <span id="totalIncome" class="summary-value">£0.00</span>
            </div>
            <div class="glass-card summary-card">
                <span class="summary-label">Expenses</span>
                <span id="totalExpenses" class="summary-value">£0.00</span>
            </div>
            <div class="glass-card summary-card balance">
                <span class="summary-label" style="color: rgba(255,255,255,0.7);">Total Balance</span>
                <span id="balance" class="summary-value">£0.00</span>
            </div>
        </section>

        <section class="glass-card budget-overview fade-in" style="animation-delay: 0.2s;">
            <h3 class="section-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="var(--accent-teal)"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
                Breakdown
            </h3>
            <div id="expenseBreakdownContainer"></div>
        </section>

        <section class="transaction-list fade-in" style="animation-delay: 0.3s;">
            <h3 class="section-title">Recent Activity</h3>
            <div id="transactionsContainer"></div>
        </section>
    </div>

    <button class="fab" id="addTransactionBtn">
        <svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </button>

    <div id="transactionModal" class="modal">
        <div class="modal-card">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Add Transaction</h2>
                <button class="close-modal" id="closeTxnModal"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            <form id="transactionForm">
                <input type="hidden" id="transactionId">
                <div class="form-group">
                    <div class="toggle-container">
                        <button type="button" id="expenseToggleBtn" class="toggle-option active expense">Expense</button>
                        <button type="button" id="incomeToggleBtn" class="toggle-option">Income</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="label">Amount</label>
                    <input type="number" id="amount" class="input-field" placeholder="0.00" required step="0.01" style="font-size: 24px; font-weight: 700; color: var(--accent-teal);">
                </div>
                <div class="form-group">
                    <label class="label">Title</label>
                    <input type="text" id="description" class="input-field" placeholder="What is this for?" required>
                </div>
                <div class="form-group">
                    <label class="label">Category</label>
                    <div class="category-select-wrapper">
                        <select id="category" class="input-field" required></select>
                        <button type="button" id="toggleAddCat" class="input-field" style="width: auto; padding: 10px;">+</button>
                    </div>
                    <div id="newCategoryContainer" class="hidden" style="margin-top: 10px; display: flex; gap: 8px;">
                        <input type="text" id="newCategory" class="input-field" placeholder="New Category Name">
                        <button type="button" id="saveCategoryBtn" class="primary-btn" style="width: auto; margin:0; background: var(--accent-blue); color: white;">Add</button>
                    </div>
                </div>
                <div class="form-group">
                    <label class="label">Date</label>
                    <input type="date" id="date" class="input-field" required>
                </div>
                <div class="form-group row-group">
                    <span class="label" style="margin:0">Recurring Payment?</span>
                    <label class="switch">
                        <input type="checkbox" id="recurring">
                        <span class="slider"></span>
                    </label>
                </div>
                <div id="recurringOptions" class="hidden">
                    <div class="form-group" style="margin-top: 15px;">
                        <label class="label">Frequency</label>
                        <select id="frequency" class="input-field">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly">Monthly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="primary-btn">Save</button>
            </form>
        </div>
    </div>

    <div id="settingsModal" class="modal">
        <div class="modal-card">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <button class="close-modal" id="closeSettingsModal"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>
            </div>
            
            <h3 class="label" style="margin-bottom: 15px; font-size: 15px; color: var(--primary-text);">Recurring Items</h3>
            <ul id="recurringList" style="list-style: none;"></ul>
            
            <div class="danger-zone">
                <button id="clearDataBtn" class="primary-btn danger-btn">Reset All Data</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            /* * DATA & CONFIG 
             * Preserving original localStorage keys to ensure data safety.
             */
            // Updated Categories List
            const initialCategories = [
                'Food', 'Transport', 'Salary', 'Utilities', 'Entertainment', 'Shopping', 'Health', 
                'Investments', 'Savings', 'Gifts', 'Credit Card', 'Eating Out', 'Other'
            ];

            // Icons mapping
            const categoryIcons = {
                'Food': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>',
                'Eating Out': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11 9H9V2H7v7H5V2H3v7c0 2.12 1.66 3.84 3.75 3.97V22h2.5v-9.03C11.34 12.84 13 11.12 13 9V2h-2v7zm5-3v8h2.5v8H21V2c-2.76 0-5 2.24-5 4z"/></svg>', // Same as Food for now
                'Transport': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z"/></svg>',
                'Salary': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z"/></svg>',
                'Utilities': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 2v11h3v9l7-12h-4l4-8z"/></svg>',
                'Entertainment': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M21 5.82L9 2 21 2v3.82zM6 16c0-3.31 2.69-6 6-6s6 2.69 6 6-2.69 6-6 6-6-2.69-6-6zM15 5H9v8.62c.94-.48 2-.59 2.97-.24l3.03-1.2V5z"/></svg>',
                'Shopping': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 6h-2c0-2.21-1.79-4-4-4S9 3.79 9 6H7c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-2c1.1 0 2 .9 2 2h-4c0-1.1.9-2 2-2zm7 14H7V8h2v2c0 .55.45 1 1 1s1-.45 1-1V8h4v2c0 .55.45 1 1 1s1-.45 1-1V8h2v10z"/></svg>',
                'Health': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 3H5c-1.1 0-1.99.9-1.99 2L3 19c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-1 11h-4v4h-4v-4H6v-4h4V6h4v4h4v4z"/></svg>',
                'Investments': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M3.5 18.49l6-6.01 4 4L22 6.92l-1.41-1.41-7.09 7.97-4-4L2 16.99z"/></svg>',
                'Savings': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M19 14V6c0-1.1-.9-2-2-2H3c-1.1 0-2 .9-2 2v8c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2zm-9-1c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3z"/><path d="M5 22h14c1.1 0 2-.9 2-2v-1h-2v1H5v-2h14v-2H5V6h1v-2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2z"/></svg>',
                'Gifts': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/></svg>',
                'Credit Card': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M20 4H4c-1.11 0-2.01.89-2.01 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z"/></svg>',
                'Default': '<svg viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>'
            };

            const categoryColors = {
                'Food': '#FF5A8D', 'Eating Out': '#FF2E93', 'Transport': '#5A9CFF', 'Salary': '#00F0FF',
                'Utilities': '#FFD60A', 'Entertainment': '#BD00FF', 'Shopping': '#FF9F0A', 'Health': '#30D158',
                'Investments': '#9D4EDD', 'Savings': '#00B4D8', 'Gifts': '#FF70A6', 'Credit Card': '#F72585',
                'Other': '#8E8E93'
            };

            const state = { 
                transactions: [], 
                categories: [], 
                recurringTransactions: [], 
                currentDate: new Date() 
            };

            const db = {
                load: () => {
                    const t = localStorage.getItem('transactions_v2');
                    const c = localStorage.getItem('categories_v2');
                    const r = localStorage.getItem('recurringTransactions_v2');
                    
                    if (t) state.transactions = JSON.parse(t);
                    
                    // Merge new categories with existing ones if any, or use initial set
                    if (c) {
                        const loadedCats = JSON.parse(c);
                        const mergedCats = [...new Set([...loadedCats, ...initialCategories])]; // simple merge
                        state.categories = mergedCats;
                    } else {
                        state.categories = [...initialCategories];
                        db.save('categories_v2', state.categories);
                    }

                    if (r) state.recurringTransactions = JSON.parse(r);
                    
                    // Process Recurring
                    const lastVisitStr = localStorage.getItem('lastVisit_v2');
                    if (lastVisitStr) {
                        const lastVisit = new Date(lastVisitStr);
                        const now = new Date();
                        let newTxns = [];
                        
                        state.recurringTransactions.forEach(item => {
                            let nextDueDate = new Date(item.startDate);
                            const endDate = item.endDate ? new Date(item.endDate) : null;
                            
                            // Fast forward to last visit
                            while(nextDueDate <= lastVisit) {
                                nextDueDate = getNextDate(nextDueDate, item.frequency);
                            }
                            
                            // Generate missed transactions until now
                            while (nextDueDate <= now && (!endDate || nextDueDate <= endDate)) {
                                const dupe = state.transactions.some(tx => 
                                    tx.recurringId === item.id && 
                                    new Date(tx.date).toDateString() === nextDueDate.toDateString()
                                );
                                if (!dupe) {
                                    newTxns.push({
                                        ...item.transactionDetails,
                                        id: `txn_${Date.now()}_${Math.random()}`,
                                        date: nextDueDate.toISOString().split('T')[0],
                                        recurringId: item.id
                                    });
                                }
                                nextDueDate = getNextDate(nextDueDate, item.frequency);
                            }
                        });
                        
                        if (newTxns.length) {
                            state.transactions.push(...newTxns);
                            db.save('transactions_v2', state.transactions);
                        }
                    }
                    localStorage.setItem('lastVisit_v2', new Date().toISOString());
                },
                save: (key, data) => localStorage.setItem(key, JSON.stringify(data)),
                clear: () => {
                    if(!confirm('This will wipe all data. Are you absolutely sure?')) return;
                    localStorage.clear();
                    location.reload();
                }
            };

            const getNextDate = (date, freq) => {
                const d = new Date(date);
                if (freq === 'daily') d.setDate(d.getDate() + 1);
                if (freq === 'weekly') d.setDate(d.getDate() + 7);
                if (freq === 'monthly') d.setMonth(d.getMonth() + 1);
                if (freq === 'yearly') d.setFullYear(d.getFullYear() + 1);
                return d;
            };

            /* UI CONTROLLERS */
            const els = {
                dateHeader: document.getElementById('headerDate'),
                incEl: document.getElementById('totalIncome'),
                expEl: document.getElementById('totalExpenses'),
                balEl: document.getElementById('balance'),
                list: document.getElementById('transactionsContainer'),
                breakdown: document.getElementById('expenseBreakdownContainer'),
                
                // Modals
                txModal: document.getElementById('transactionModal'),
                setModal: document.getElementById('settingsModal'),
                
                // Forms
                form: document.getElementById('transactionForm'),
                amt: document.getElementById('amount'),
                desc: document.getElementById('description'),
                cat: document.getElementById('category'),
                date: document.getElementById('date'),
                rec: document.getElementById('recurring'),
                
                // Buttons
                addBtn: document.getElementById('addTransactionBtn'),
                settingsBtn: document.getElementById('openSettingsBtn'),
                prev: document.getElementById('prevMonthBtn'),
                next: document.getElementById('nextMonthBtn')
            };

            let currentType = 'expense';
            let editId = null;

            const formatMoney = (n) => new Intl.NumberFormat('en-GB', { style: 'currency', currency: 'GBP' }).format(n);

            const render = () => {
                // Filter by month
                const y = state.currentDate.getFullYear();
                const m = state.currentDate.getMonth();
                
                els.dateHeader.textContent = state.currentDate.toLocaleDateString('en-GB', { month: 'long', year: 'numeric' });
                
                const monthTxns = state.transactions.filter(t => {
                    const d = new Date(t.date);
                    return d.getFullYear() === y && d.getMonth() === m;
                }).sort((a,b) => new Date(b.date) - new Date(a.date));

                // Summary
                const income = monthTxns.filter(t => t.type === 'income').reduce((a,b) => a + b.amount, 0);
                const expense = monthTxns.filter(t => t.type === 'expense').reduce((a,b) => a + b.amount, 0);
                
                els.incEl.textContent = formatMoney(income);
                els.expEl.textContent = formatMoney(expense);
                els.balEl.textContent = formatMoney(income - expense);

                // List
                els.list.innerHTML = '';
                if (monthTxns.length === 0) {
                    els.list.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            <p>No transactions this month.</p>
                        </div>`;
                } else {
                    monthTxns.forEach((t, i) => {
                        const icon = categoryIcons[t.category] || categoryIcons['Default'];
                        const color = categoryColors[t.category] || categoryColors['Other'];
                        const isInc = t.type === 'income';
                        
                        const el = document.createElement('div');
                        el.className = `transaction-item ${i < 5 ? 'fade-in' : ''}`;
                        el.style.animationDelay = `${i * 0.05}s`;
                        
                        el.innerHTML = `
                            <div class="swipe-actions">
                                <button class="swipe-btn edit" onclick="editTx('${t.id}')">
                                    <svg viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/></svg>
                                    Edit
                                </button>
                                <button class="swipe-btn delete" onclick="delTx('${t.id}')">
                                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                                    Delete
                                </button>
                            </div>
                            <div class="txn-content" ontouchstart="handleTouchStart(event, this)" ontouchend="handleTouchEnd(event, this)">
                                <div class="txn-icon" style="color: ${color}; background: ${color}15">
                                    ${icon}
                                </div>
                                <div class="txn-info">
                                    <div class="txn-desc">${t.description}</div>
                                    <div class="txn-meta">${new Date(t.date).toLocaleDateString('en-GB', {day:'numeric', month:'short'})} • ${t.category}</div>
                                </div>
                                <div class="txn-amount ${t.type}">${isInc ? '+' : '-'}${formatMoney(t.amount)}</div>
                            </div>
                        `;
                        els.list.appendChild(el);
                    });
                }

                // Breakdown
                const catTotals = {};
                let totalExp = 0;
                monthTxns.filter(t => t.type === 'expense').forEach(t => {
                    catTotals[t.category] = (catTotals[t.category] || 0) + t.amount;
                    totalExp += t.amount;
                });

                els.breakdown.innerHTML = '';
                if (totalExp === 0) {
                     els.breakdown.innerHTML = '<p style="text-align:center; color:var(--secondary-text); font-size:13px; padding:10px;">No expenses yet.</p>';
                } else {
                    Object.entries(catTotals)
                        .sort(([,a], [,b]) => b - a)
                        .slice(0, 5) // Top 5
                        .forEach(([cat, amt]) => {
                            const pct = (amt / totalExp) * 100;
                            const color = categoryColors[cat] || categoryColors['Other'];
                            
                            const div = document.createElement('div');
                            div.className = 'breakdown-item';
                            div.innerHTML = `
                                <div class="breakdown-header">
                                    <span class="cat-name">${cat}</span>
                                    <span class="cat-amount">${formatMoney(amt)}</span>
                                </div>
                                <div class="progress-track">
                                    <div class="progress-fill" style="width: ${pct}%; background-color: ${color};"></div>
                                </div>
                            `;
                            els.breakdown.appendChild(div);
                        });
                }
                
                // Settings List
                const recList = document.getElementById('recurringList');
                recList.innerHTML = '';
                state.recurringTransactions.forEach(r => {
                    const li = document.createElement('li');
                    li.style.cssText = "display:flex; justify-content:space-between; padding:12px; background:rgba(255,255,255,0.03); margin-bottom:8px; border-radius:8px;";
                    li.innerHTML = `
                        <span style="font-size:14px;">${r.transactionDetails.description} (${r.frequency})</span>
                        <button onclick="delRec('${r.id}')" style="background:none; border:none; color:var(--accent-pink); font-weight:600;">Remove</button>
                    `;
                    recList.appendChild(li);
                });
            };

            /* INTERACTIONS */
            
            // Touch Swipe Logic
            let xStart = 0;
            window.handleTouchStart = (e, el) => { xStart = e.changedTouches[0].screenX; };
            window.handleTouchEnd = (e, el) => {
                const xEnd = e.changedTouches[0].screenX;
                const parent = el.parentElement;
                
                // Reset others
                document.querySelectorAll('.transaction-item.swiped').forEach(i => {
                    if(i !== parent) i.classList.remove('swiped');
                });
                
                if (xStart - xEnd > 60) parent.classList.add('swiped'); // Swipe Left
                if (xEnd - xStart > 60) parent.classList.remove('swiped'); // Swipe Right
            };

            // Global functions for inline HTML event handlers
            window.editTx = (id) => {
                const t = state.transactions.find(x => x.id === id);
                if(!t) return;
                
                editId = id;
                document.getElementById('modalTitle').textContent = 'Edit Transaction';
                els.amt.value = t.amount;
                els.desc.value = t.description;
                els.cat.value = t.category;
                els.date.value = t.date;
                setType(t.type);
                
                // Hide recurring for edit
                els.rec.parentElement.parentElement.classList.add('hidden');
                
                openModal(els.txModal);
            };
            
            window.delTx = (id) => {
                if(confirm('Delete this transaction?')) {
                    state.transactions = state.transactions.filter(t => t.id !== id);
                    db.save('transactions_v2', state.transactions);
                    render();
                }
            };
            
            window.delRec = (id) => {
                state.recurringTransactions = state.recurringTransactions.filter(r => r.id !== id);
                db.save('recurringTransactions_v2', state.recurringTransactions);
                render();
            };

            const setType = (type) => {
                currentType = type;
                const btns = document.querySelectorAll('.toggle-option');
                btns.forEach(b => b.classList.remove('active'));
                
                if (type === 'expense') {
                    document.getElementById('expenseToggleBtn').classList.add('active', 'expense');
                    els.amt.style.color = 'var(--accent-pink)';
                } else {
                    document.getElementById('incomeToggleBtn').classList.add('active', 'income');
                    els.amt.style.color = 'var(--accent-teal)';
                }
            };

            const openModal = (m) => { m.classList.add('open'); };
            const closeModal = (m) => { 
                m.classList.remove('open');
                // Reset form slightly delayed
                if(m === els.txModal) {
                    setTimeout(() => {
                        editId = null;
                        els.form.reset();
                        els.date.valueAsDate = new Date();
                        setType('expense');
                        els.rec.parentElement.parentElement.classList.remove('hidden');
                        document.getElementById('recurringOptions').classList.add('hidden');
                    }, 300);
                }
            };

            /* EVENT LISTENERS */
            
            els.prev.onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth()-1); render(); };
            els.next.onclick = () => { state.currentDate.setMonth(state.currentDate.getMonth()+1); render(); };
            
            els.addBtn.onclick = () => { 
                document.getElementById('modalTitle').textContent = 'New Transaction';
                els.date.valueAsDate = new Date();
                populateCategories();
                openModal(els.txModal); 
            };
            
            els.settingsBtn.onclick = () => openModal(els.setModal);
            
            document.getElementById('closeTxnModal').onclick = () => closeModal(els.txModal);
            document.getElementById('closeSettingsModal').onclick = () => closeModal(els.setModal);
            
            document.getElementById('expenseToggleBtn').onclick = () => setType('expense');
            document.getElementById('incomeToggleBtn').onclick = () => setType('income');
            
            els.rec.onchange = (e) => {
                const opts = document.getElementById('recurringOptions');
                if(e.target.checked) opts.classList.remove('hidden');
                else opts.classList.add('hidden');
            };

            // Category Management
            const populateCategories = () => {
                els.cat.innerHTML = '';
                state.categories.forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c; opt.textContent = c;
                    els.cat.appendChild(opt);
                });
            };
            
            document.getElementById('toggleAddCat').onclick = () => {
                document.getElementById('newCategoryContainer').classList.toggle('hidden');
            };
            
            document.getElementById('saveCategoryBtn').onclick = () => {
                const val = document.getElementById('newCategory').value.trim();
                if(val && !state.categories.includes(val)) {
                    state.categories.push(val);
                    db.save('categories_v2', state.categories);
                    populateCategories();
                    els.cat.value = val;
                    document.getElementById('newCategoryContainer').classList.add('hidden');
                    document.getElementById('newCategory').value = '';
                }
            };

            els.form.onsubmit = (e) => {
                e.preventDefault();
                const txn = {
                    type: currentType,
                    amount: parseFloat(els.amt.value),
                    description: els.desc.value,
                    category: els.cat.value,
                    date: els.date.value
                };

                if (editId) {
                    const idx = state.transactions.findIndex(t => t.id === editId);
                    if(idx > -1) state.transactions[idx] = { ...state.transactions[idx], ...txn };
                } else {
                    const newId = `txn_${Date.now()}`;
                    if (els.rec.checked) {
                        const recItem = {
                            id: `rec_${Date.now()}`,
                            transactionDetails: txn,
                            frequency: document.getElementById('frequency').value,
                            startDate: txn.date
                        };
                        state.recurringTransactions.push(recItem);
                        db.save('recurringTransactions_v2', state.recurringTransactions);
                        txn.recurringId = recItem.id;
                    }
                    state.transactions.push({ ...txn, id: newId });
                }

                db.save('transactions_v2', state.transactions);
                render();
                closeModal(els.txModal);
            };

            document.getElementById('clearDataBtn').onclick = db.clear;

            // BACKGROUND PARTICLES
            const canvas = document.getElementById('particle-canvas');
            const ctx = canvas.getContext('2d');
            let particles = [];
            
            const resize = () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            };
            window.addEventListener('resize', resize);
            resize();

            class Particle {
                constructor() {
                    this.reset();
                }
                reset() {
                    this.x = Math.random() * canvas.width;
                    this.y = Math.random() * canvas.height;
                    this.size = Math.random() * 2;
                    this.speedX = (Math.random() - 0.5) * 0.2;
                    this.speedY = (Math.random() - 0.5) * 0.2;
                    this.alpha = Math.random() * 0.5;
                }
                update() {
                    this.x += this.speedX;
                    this.y += this.speedY;
                    if(this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) this.reset();
                }
                draw() {
                    ctx.fillStyle = `rgba(255, 255, 255, ${this.alpha})`;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }

            for(let i=0; i<40; i++) particles.push(new Particle());
            
            const animate = () => {
                ctx.clearRect(0,0, canvas.width, canvas.height);
                particles.forEach(p => { p.update(); p.draw(); });
                requestAnimationFrame(animate);
            };
            animate();

            // INIT
            db.load();
            render();
            populateCategories();
        });
    </script>
</body>
</html>